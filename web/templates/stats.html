{{define "content"}}
<h2>Apigee Proxy Stats (max duration)</h2>
<div class="row">
  <div class="col s12 m3">
    <form id="statsForm">
      <div class="input-field">
        <input type="text" id="proxyName" name="proxyName" />
        <label for="proxyName">Proxy Name (optional)</label>
      </div>
      <div class="input-field">
        <select id="timeRange" name="timeRange">
          <option value="1h">1 hour</option>
          <option value="6h">6 hours</option>
          <option value="12h">12 hours</option>
          <option value="1d">1 day</option>
          <option value="7d">7 days</option>
        </select>
        <label for="timeRange">Time Range</label>
      </div>
      <button class="btn waves-effect waves-light" type="submit">Search</button>
    </form>
  </div>
  <div class="col s12 m9">
    <table id="statsTable" class="striped">
      <thead>
        <!-- Headers will be dynamically inserted here -->
      </thead>
      <tbody>
        <!-- Data rows will be dynamically inserted here -->
      </tbody>
    </table>
  </div>
</div>
{{end}} {{define "scripts"}}
<script>
    function snakeToTitleCase(str) {
        return str.split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }

  $(document).ready(function () {
    $('select').formSelect();
    function loadStats() {
      $.ajax({
        url: "/api/stats",
        method: "GET",
        data: $("#statsForm").serialize(),
        success: function (response) {
          var tbody = $("#statsTable tbody");
          var thead = $("#statsTable thead");
          tbody.empty();
          thead.empty();

          // Add headers
          var headerRow = $("<tr>");
          response.headers.forEach(function (header) {
            headerRow.append($('<th>').text(snakeToTitleCase(header)));
          });
          thead.append(headerRow);

          // Add data rows
          response.data.forEach(function (row) {
            var tr = $("<tr>");
            row.forEach(function (cell) {
              tr.append($("<td>").text(cell));
            });
            tbody.append(tr);
          });
        },
        error: function (xhr, status, error) {
          console.error("Error fetching stats:", error);
          console.error("Status:", status);
          console.error("Response:", xhr.responseText);
        },
      });
    }

    $("#statsForm").submit(function (e) {
      e.preventDefault();
      loadStats();
    });

    loadStats();
  });
</script>
{{end}}
